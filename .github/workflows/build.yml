name: Build & Test

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            cef-platform: windows64
            bin-folder: bin_win
          - os: ubuntu-22.04
            cef-platform: linux64
            bin-folder: bin_linux

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install scikit-build cython pytest

      - name: Cache CEF binaries
        uses: actions/cache@v4
        id: cef-cache
        with:
          path: cef-binaries-${{ matrix.cef-platform }}
          key: cef-145.0.26-${{ matrix.cef-platform }}

      - name: Download CEF binaries
        if: steps.cef-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          CEF_VERSION="145.0.26+g3834787+chromium-145.0.6422.142"
          CEF_FILENAME="cef_binary_${CEF_VERSION}_${{ matrix.cef-platform }}"
          CEF_URL="https://cef-builds.spotifycdn.com/${CEF_FILENAME}.tar.bz2"
          echo "Downloading CEF from ${CEF_URL}..."
          curl -L -o cef.tar.bz2 "${CEF_URL}" || echo "CEF download failed - check URL"
          if [ -f cef.tar.bz2 ]; then
            tar xjf cef.tar.bz2
            if [ "${{ matrix.cef-platform }}" = "windows64" ]; then
              mv "${CEF_FILENAME}" cef-binaries-windows || true
            else
              mv "${CEF_FILENAME}" cef-binaries-linux || true
            fi
          fi

      - name: Build C++ library (CMake)
        shell: bash
        run: |
          cmake -B build -DUSE_SANDBOX=OFF -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release --parallel

      - name: Build Python wheel
        working-directory: src/pytonium_python_framework
        run: |
          pip install -e .

      - name: Run tests
        run: |
          python -m pytest tests/ -v
