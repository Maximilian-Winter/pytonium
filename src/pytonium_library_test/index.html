<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pytonium C++ Callback Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }
        
        /* Custom title bar for frameless window */
        .titlebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .titlebar .title {
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .titlebar .title::before {
            content: "âš¡";
            font-size: 18px;
        }
        
        .titlebar .controls {
            display: flex;
            gap: 8px;
        }
        
        .titlebar button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
            transition: background 0.2s;
        }
        
        .titlebar button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .titlebar button.close:hover {
            background: #e74c3c;
        }
        
        .content {
            padding: 20px;
        }
        
        h1 {
            color: #333;
            margin-top: 0;
        }
        
        .section {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        
        .section button:hover {
            background-color: #0056b3;
        }
        
        #output {
            background: #333;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            min-height: 150px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            white-space: pre-wrap;
        }
        
        #date {
            color: #666;
            font-style: italic;
            margin-top: 10px;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            display: inline-block;
            margin: 5px 0;
        }
        
        .status.ok {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status.waiting {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .frameless-note {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px 15px;
            margin: 10px 0;
            border-radius: 0 4px 4px 0;
        }
        
        .frameless-note strong {
            color: #1976d2;
        }
        
        /* Resize handles for frameless window */
        .resize-handle {
            position: fixed;
            z-index: 9999;
            background: transparent;
        }
        
        .resize-handle:hover {
            background: rgba(102, 126, 234, 0.3);
        }
        
        /* Edge handles */
        .resize-n { top: 0; left: 8px; right: 8px; height: 8px; cursor: n-resize; }
        .resize-s { bottom: 0; left: 8px; right: 8px; height: 8px; cursor: s-resize; }
        .resize-w { left: 0; top: 8px; bottom: 8px; width: 8px; cursor: w-resize; }
        .resize-e { right: 0; top: 8px; bottom: 8px; width: 8px; cursor: e-resize; }
        
        /* Corner handles */
        .resize-nw { top: 0; left: 0; width: 16px; height: 16px; cursor: nw-resize; }
        .resize-ne { top: 0; right: 0; width: 16px; height: 16px; cursor: ne-resize; }
        .resize-sw { bottom: 0; left: 0; width: 16px; height: 16px; cursor: sw-resize; }
        .resize-se { bottom: 0; right: 0; width: 16px; height: 16px; cursor: se-resize; }
        
        /* UI Feedback display */
        #ui-feedback {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 8px;
            padding: 15px;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .feedback-item {
            background: white;
            border-left: 4px solid #667eea;
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 0 4px 4px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease-out;
        }
        
        .feedback-item.success {
            border-left-color: #4caf50;
        }
        
        .feedback-item.error {
            border-left-color: #f44336;
        }
        
        .feedback-item.info {
            border-left-color: #2196f3;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <!-- Resize handles for frameless window -->
    <div class="resize-handle resize-n" data-edge="n"></div>
    <div class="resize-handle resize-s" data-edge="s"></div>
    <div class="resize-handle resize-w" data-edge="w"></div>
    <div class="resize-handle resize-e" data-edge="e"></div>
    <div class="resize-handle resize-nw" data-edge="nw"></div>
    <div class="resize-handle resize-ne" data-edge="ne"></div>
    <div class="resize-handle resize-sw" data-edge="sw"></div>
    <div class="resize-handle resize-se" data-edge="se"></div>
    
    <!-- Custom title bar for frameless window -->
    <div class="titlebar">
        <div class="title">Pytonium C++ Test</div>
        <div class="controls">
            <button onclick="minimizeWindow()" title="Minimize">_</button>
            <button onclick="maximizeWindow()" title="Maximize">â–¡</button>
            <button class="close" onclick="closeWindow()" title="Close">Ã—</button>
        </div>
    </div>
    
    <div class="content">
        <div class="frameless-note">
            <strong>Frameless Window Mode:</strong> This window has a custom title bar created with HTML/CSS. 
            The Chrome UI (tabs, address bar) has been removed. 
            <strong>Click and drag the title bar</strong> to move, <strong>drag edges/corners</strong> to resize.
            Set <code>SetFramelessWindow(false)</code> in main.cpp to restore the standard window.
        </div>
        
        <h1>Pytonium C++ Callback Test</h1>
        
        <div class="section">
            <h2>Test Function Bindings</h2>
            <button onclick="callTestFunc()">Call testfunc() (returns object)</button>
            <button onclick="callTestOne()">Call test_one() (returns object)</button>
            <button onclick="callTestTwo()">Call test_two() (no return)</button>
        </div>

        <div class="section">
            <h2>State Management Test</h2>
            <div id="status" class="status waiting">Waiting for Pytonium...</div>
            <div id="date">Waiting for state updates from C++...</div>
            <button onclick="setUserState()">Set User State from JS</button>
        </div>

        <div class="section">
            <h2>UI Feedback</h2>
            <div id="ui-feedback">
                <div class="feedback-item">Click buttons above to see reactions here...</div>
            </div>
        </div>

        <div class="section">
            <h2>Output Log</h2>
            <div id="output"></div>
        </div>
    </div>

</body>
<script>
    const output = document.getElementById('output');
    const statusDiv = document.getElementById('status');
    const dateDiv = document.getElementById('date');
    let logLineCount = 0;
    const maxLogLines = 100;
    
    function log(msg) {
        const timestamp = new Date().toLocaleTimeString();
        output.textContent += '[' + timestamp + '] ' + msg + '\n';
        logLineCount++;
        
        // Limit log size
        if (logLineCount > maxLogLines) {
            const lines = output.textContent.split('\n');
            output.textContent = lines.slice(lines.length - maxLogLines).join('\n');
            logLineCount = maxLogLines;
        }
        
        output.scrollTop = output.scrollHeight;
    }
    
    // UI Feedback display function
    const feedbackContainer = document.getElementById('ui-feedback');
    let feedbackCount = 0;
    const maxFeedbackItems = 10;
    
    function showFeedback(message, type = 'info') {
        // Remove placeholder if present
        if (feedbackCount === 0) {
            feedbackContainer.innerHTML = '';
        }
        
        const item = document.createElement('div');
        item.className = 'feedback-item ' + type;
        
        const timestamp = new Date().toLocaleTimeString();
        item.innerHTML = '<strong>' + timestamp + '</strong> - ' + message;
        
        feedbackContainer.insertBefore(item, feedbackContainer.firstChild);
        feedbackCount++;
        
        // Limit number of feedback items
        while (feedbackContainer.children.length > maxFeedbackItems) {
            feedbackContainer.removeChild(feedbackContainer.lastChild);
        }
    }

    // Window control functions - these call the C++ bindings
    function minimizeWindow() {
        showFeedback('Minimize button clicked', 'info');
        log('Minimizing window...');
        try {
            Pytonium.window.minimize();
            showFeedback('Window minimized successfully', 'success');
        } catch (e) {
            showFeedback('Minimize failed: ' + e.message, 'error');
            log('Minimize error: ' + e.message);
        }
    }
    
    function maximizeWindow() {
        showFeedback('Maximize/Restore button clicked', 'info');
        log('Maximizing/Restoring window...');
        try {
            Pytonium.window.maximize();
            showFeedback('Window maximized/restored successfully', 'success');
        } catch (e) {
            showFeedback('Maximize failed: ' + e.message, 'error');
            log('Maximize error: ' + e.message);
        }
    }
    
    function closeWindow() {
        showFeedback('Close button clicked - Closing application...', 'info');
        log('Closing window...');
        try {
            Pytonium.window.close();
        } catch (e) {
            showFeedback('Close failed: ' + e.message, 'error');
            log('Close error: ' + e.message);
        }
    }
    
    // Draggable title bar functionality - smooth dragging
    let isDragging = false;
    let dragStartMouseX = 0;
    let dragStartMouseY = 0;
    let dragStartWindowX = 0;
    let dragStartWindowY = 0;
    
    async function initDraggableTitlebar() {
        const titlebar = document.querySelector('.titlebar');
        if (!titlebar) return;
        
        titlebar.addEventListener('mousedown', async function(e) {
            // Don't drag if clicking on buttons
            if (e.target.tagName === 'BUTTON' || e.target.closest('.controls')) {
                return;
            }
            
            // Check if window is maximized
            try {
                let result = await Pytonium.window.isMaximized();
                if (result) return;
            } catch (err) {}
            
            isDragging = true;
            dragStartMouseX = e.screenX;
            dragStartMouseY = e.screenY;
            
            // Get current window position
            try {
                let pos = await Pytonium.window.getPosition();
                dragStartWindowX = pos.x;
                dragStartWindowY = pos.y;
            } catch (err) {
                dragStartWindowX = 0;
                dragStartWindowY = 0;
            }
            
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            
            const deltaX = e.screenX - dragStartMouseX;
            const deltaY = e.screenY - dragStartMouseY;
            
            const newX = dragStartWindowX + deltaX;
            const newY = dragStartWindowY + deltaY;
            
            // Direct position update - much smoother than delta accumulation
            Pytonium.window.setPosition(newX, newY);
        });
        
        document.addEventListener('mouseup', function() {
            isDragging = false;
        });
    }
    
    // Window resizing functionality
    let isResizing = false;
    let resizeEdge = '';
    let resizeStartX = 0;
    let resizeStartY = 0;
    let resizeStartWidth = 0;
    let resizeStartHeight = 0;
    let resizeStartWindowX = 0;
    let resizeStartWindowY = 0;
    
    async function initResizableWindow() {
        const handles = document.querySelectorAll('.resize-handle');
        
        handles.forEach(handle => {
            handle.addEventListener('mousedown', async function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                isResizing = true;
                resizeEdge = handle.dataset.edge;
                resizeStartX = e.screenX;
                resizeStartY = e.screenY;
                
                // Get current window size and position
                try {
                    let size = await Pytonium.window.getSize();
                    let pos = await Pytonium.window.getPosition();
                    resizeStartWidth = size.width;
                    resizeStartHeight = size.height;
                    resizeStartWindowX = pos.x;
                    resizeStartWindowY = pos.y;
                } catch (err) {
                    return;
                }
            });
        });
        
        document.addEventListener('mousemove', function(e) {
            if (!isResizing) return;
            
            const deltaX = e.screenX - resizeStartX;
            const deltaY = e.screenY - resizeStartY;
            
            let newWidth = resizeStartWidth;
            let newHeight = resizeStartHeight;
            let anchor = 0; // Default: top-left anchor
            
            // Calculate new size based on which edge is being dragged
            // Anchor determines which corner stays fixed
            switch (resizeEdge) {
                case 'e': // Right edge - expand right
                    newWidth = resizeStartWidth + deltaX;
                    anchor = 0; // Top-left fixed
                    break;
                case 'w': // Left edge - expand left, move left
                    newWidth = resizeStartWidth - deltaX;
                    anchor = 1; // Top-right fixed
                    break;
                case 's': // Bottom edge - expand down
                    newHeight = resizeStartHeight + deltaY;
                    anchor = 0; // Top-left fixed
                    break;
                case 'n': // Top edge - expand up, move up
                    newHeight = resizeStartHeight - deltaY;
                    anchor = 2; // Bottom-left fixed
                    break;
                case 'se': // Bottom-right corner
                    newWidth = resizeStartWidth + deltaX;
                    newHeight = resizeStartHeight + deltaY;
                    anchor = 0; // Top-left fixed
                    break;
                case 'sw': // Bottom-left corner
                    newWidth = resizeStartWidth - deltaX;
                    newHeight = resizeStartHeight + deltaY;
                    anchor = 1; // Top-right fixed
                    break;
                case 'ne': // Top-right corner
                    newWidth = resizeStartWidth + deltaX;
                    newHeight = resizeStartHeight - deltaY;
                    anchor = 2; // Bottom-left fixed
                    break;
                case 'nw': // Top-left corner
                    newWidth = resizeStartWidth - deltaX;
                    newHeight = resizeStartHeight - deltaY;
                    anchor = 3; // Bottom-right fixed
                    break;
            }
            
            // Minimum window size
            const minWidth = 400;
            const minHeight = 300;
            
            if (newWidth >= minWidth && newHeight >= minHeight) {
                Pytonium.window.resize(newWidth, newHeight, anchor);
            }
        });
        
        document.addEventListener('mouseup', function() {
            isResizing = false;
            resizeEdge = '';
        });
    }

    // Test calling testfunc() which returns an object
    function callTestFunc() {
        showFeedback('Button clicked: testfunc()', 'info');
        log('Calling Pytonium.test_function_binding.testfunc()...');
        try {
            let myPromise = Pytonium.test_function_binding.testfunc();
            if (myPromise && typeof myPromise.then === 'function') {
                myPromise.then((resolvedValue) => {
                    showFeedback('testfunc() returned successfully!', 'success');
                    log('testfunc() returned: ' + JSON.stringify(resolvedValue));
                }).catch((err) => {
                    showFeedback('testfunc() failed: ' + err, 'error');
                    log('testfunc() error: ' + err);
                });
            } else {
                showFeedback('testfunc() returned (no promise)', 'info');
                log('testfunc() returned (no promise): ' + myPromise);
            }
        } catch (e) {
            showFeedback('testfunc() exception: ' + e.message, 'error');
            log('testfunc() exception: ' + e.message);
        }
    }

    // Test calling test_one() which returns an object
    function callTestOne() {
        showFeedback('Button clicked: test_one(64)', 'info');
        log('Calling Pytonium.test_class_methods_binding.test_one(64)...');
        try {
            let myPromise = Pytonium.test_class_methods_binding.test_one(64);
            if (myPromise && typeof myPromise.then === 'function') {
                myPromise.then((resolvedValue) => {
                    showFeedback('test_one() returned successfully!', 'success');
                    log('test_one() returned: ' + JSON.stringify(resolvedValue));
                }).catch((err) => {
                    showFeedback('test_one() failed: ' + err, 'error');
                    log('test_one() error: ' + err);
                });
            } else {
                showFeedback('test_one() returned (no promise)', 'info');
                log('test_one() returned (no promise): ' + myPromise);
            }
        } catch (e) {
            showFeedback('test_one() exception: ' + e.message, 'error');
            log('test_one() exception: ' + e.message);
        }
    }

    // Test calling test_two() which has no return value (no promise)
    function callTestTwo() {
        showFeedback('Button clicked: test_two("Hello", 20, 40)', 'info');
        log('Calling Pytonium.test_class_methods_binding.test_two("Hello", 20, 40)...');
        try {
            let result = Pytonium.test_class_methods_binding.test_two("Hello", 20, 40);
            showFeedback('test_two() executed successfully!', 'success');
            log('test_two() called. Return value: ' + result);
        } catch (e) {
            showFeedback('test_two() exception: ' + e.message, 'error');
            log('test_two() exception: ' + e.message);
        }
    }

    // Set user state from JavaScript
    function setUserState() {
        showFeedback('Button clicked: Set User State', 'info');
        try {
            Pytonium.appState.setState("user", "age", 25);
            showFeedback('User state set: age = 25', 'success');
            log('Set user state: age = 25');
            let age = Pytonium.appState.getState("user", "age");
            log('Retrieved user age from state: ' + age);
        } catch (e) {
            showFeedback('setUserState() failed: ' + e.message, 'error');
            log('setUserState() exception: ' + e.message);
        }
    }

    function Init() {
        log('Pytonium is ready!');
        statusDiv.textContent = 'Pytonium Ready';
        statusDiv.className = 'status ok';
        
        // Show welcome feedback
        showFeedback('ðŸŽ‰ Pytonium C++ Test App Started!', 'success');
        showFeedback('Click any button to see UI reactions here', 'info');
        
        // Initialize draggable title bar and resizable window
        initDraggableTitlebar();
        initResizableWindow();
        log('Title bar is draggable - click and drag to move the window');
        log('Window is resizable - drag the edges/corners');
        
        // Register for state updates from the "user" and "app-general" namespaces
        try {
            Pytonium.appState.registerForStateUpdates("StateChanged", ["user", "app-general"], true, true);
            log('Registered for state updates on "user" and "app-general" namespaces');
        } catch (e) {
            log('Failed to register for state updates: ' + e.message);
        }
        
        // Listen for state change events from C++
        document.addEventListener('StateChanged', function(event) {
            const detail = event.detail;
            log('State update from C++: namespace=' + detail.namespace + ', key=' + detail.key + ', value=' + JSON.stringify(detail.value));
            
            if (detail.namespace === 'app-general' && detail.key === 'date') {
                dateDiv.innerHTML = 'Last update from C++: ' + detail.value;
            }
        });

        // Initial calls to demonstrate the bindings work
        log('');
        log('=== Running initial callback tests ===');
        
        // Use setTimeout to space out the calls
        setTimeout(callTestFunc, 100);
        setTimeout(callTestOne, 300);
        setTimeout(callTestTwo, 500);
        setTimeout(setUserState, 700);
    }

    // Check if Python bindings are ready and call them, if not add an event listener for the PytoniumReady event.
    if (window.PytoniumReady) {
        Init();
    } else {
        window.addEventListener('PytoniumReady', function() {
            Init();
        });
    }
</script>
</html>
